<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>User Management</h2>
        <button class="btn btn-success" data-toggle="modal" data-target="#userModal" onclick="openAddModal()">Add Member</button>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Start Date</th>
                    <th>Total</th>
                    <th>This Month</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>

    <!-- User Modal (Add/Edit/Delete) -->
    <div id="userModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title" id="modalTitle">Add User</h4>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="text" id="firstname" class="form-control" placeholder="First name" required><br>
                        <input type="text" id="lastname" class="form-control" placeholder="Family name" required><br>
                        <input type="date" id="startDate" class="form-control" required><br>
                        <input type="number" id="totalContribution" class="form-control" placeholder="Total Contribution" required><br>
                        <input type="number" id="lastYearContribution" class="form-control" placeholder="Last Year Contribution" required><br>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
                        <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteUser()" style="display:none;">Delete</button>
                        <button type="button" class="close btn-primary" data-dismiss="modal">Close</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let selectedUser = null;

            // Load users from server
            function loadUsers() {
                $.get("http://localhost:3000/users", function(data) {
                    let userRows = '';
                    data.forEach(user => {
                        userRows += `<tr onclick="openEditModal(${user.id}, '${user.userName}', '${user.startDate}', ${user.totalContribution}, ${user.lastYearContribution})">                        
                            <td>${user.userName}</td>
                            <td>${user.startDate}</td>
                            <td>${user.totalContribution}</td>
                            <td>${user.lastYearContribution}</td>
                        </tr>`;
                    });
                    $("#userTable").html(userRows);
                });
            }

            loadUsers();

            // Add User Form Submit
            $("#userForm").on("submit", function(event) {
                event.preventDefault();
                
                const newUser = {
                    firstname: $("#firstname").val(),
                    lastname: $("#lastname").val(),
                    startDate: $("#startDate").val(),
                    totalContribution: $("#totalContribution").val(),
                    lastYearContribution: $("#lastYearContribution").val()
                };

                let url = "http://localhost:3000/users";
                let type = "POST";
                if (selectedUser && selectedUser.id) {
                    // Update user
                    url = `http://localhost:3000/users/${selectedUser.id}`;
                    type = "PUT";
                }

                $.ajax({
                    url: url,
                    type: type,
                    contentType: "application/json",
                    data: JSON.stringify(newUser),
                    success: function(response) {
                        $("#userModal").modal("hide");
                        loadUsers();
                    },
                    error: function(error) {
                        console.error("Error:", error);
                    }
                });
            });

            // Open Add Modal
            window.openAddModal = function() {
                selectedUser = null; // Reset selected user for Add
                $("#modalTitle").text("Add User");
                $("#submitBtn").text("Save");
                $("#deleteBtn").hide(); // Hide Delete button in Add mode
                $("#userForm")[0].reset(); // Reset the form
            }

         // Open Edit Modal and Fetch Latest Data by ID
window.openEditModal = function(id) {
    // Make an AJAX GET request to fetch the specific user's data by ID
    $.get(`http://localhost:3000/users/${id}`, function(user) {
        selectedUser = user; 
        console.log({selectedUser}) // Store the fetched user data in selectedUser
        $("#modalTitle").text("Edit User");
        $("#submitBtn").text("Update");
        $("#deleteBtn").show(); // Show Delete button in Edit mode

        // Populate the form with the fetched user data
        $("#firstname").val(user.firstname);
        $("#lastname").val(user.lastname);
        $("#startDate").val(user.startDate);
        $("#totalContribution").val(user.totalContribution);
        $("#lastYearContribution").val(user.lastYearContribution);

        // Open the modal
        $("#userModal").modal("show");
    }).fail(function() {
        alert("Error fetching user data.");
    });
}


            // Delete User Function
            window.deleteUser = function() {
                if (selectedUser && selectedUser.id) {
                    if (confirm("Are you sure you want to delete this user?")) {
                        $.ajax({
                            url: `http://localhost:3000/users/${selectedUser.id}`,
                            type: "DELETE",
                            success: function() {
                                $("#userModal").modal("hide");
                                loadUsers();
                            }
                        });
                    }
                }
            }
        });
    </script>
</body>
</html>

